<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graded Guard Visualizer</title>
    <!-- Favicon -->
    <link rel="icon" href="https://mew.cards/gg/img/favicon.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            darkMode: ['class', '.dark-mode'],
        }
    </script>
    
    <!-- Icon Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Loading Screen Styles */
        #loading-screen {
            position: fixed;
            inset: 0;
            background-color: #101010; 
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        #loading-screen.hidden-loader {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* 3D Effects */
        .guard-bumper {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.3), inset -2px -2px 5px rgba(0, 0, 0, 0.2), 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        .slab-css-style {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: inset 0 0 20px rgba(255,255,255,0.8);
        }

        .drop-active #cardPlaceholder {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: #60a5fa; 
            color: #3b82f6;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #18181b;
            background-image: radial-gradient(#3f3f46 1px, transparent 1px);
            color: #f4f4f5;
        }
        body.dark-mode .bg-white { background-color: #27272a; color: #f4f4f5; border-color: #3f3f46; }
        body.dark-mode .text-slate-900 { color: #fafafa; }
        body.dark-mode .text-slate-800 { color: #e4e4e7; }
        body.dark-mode .text-slate-700 { color: #d4d4d8; }
        body.dark-mode .text-slate-600 { color: #e4e4e7; }
        body.dark-mode .text-slate-500 { color: #a1a1aa; }
        body.dark-mode .bg-slate-100 { background-color: #3f3f46; }
        
        /* Company buttons */
        .company-btn { color: #64748b; }
        .company-btn:hover { color: #334155; }
        .active-company { 
            background-color: #ffffff; 
            color: #0f172a; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
        }
        
        body.dark-mode .company-btn { color: #a1a1aa; }
        body.dark-mode .company-btn:hover { color: #f4f4f5; }
        body.dark-mode .active-company { 
            background-color: #52525b; 
            color: #fff; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.5); 
            border-color: #52525b;
        }

        body.dark-mode .border-dashed { border-color: #52525b; }
        body.dark-mode .text-blue-600 { color: #cb97a5; }

        /* Theme Toggle */
        .theme-toggle-wrapper { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
        @media (min-width: 1024px) {
            .theme-toggle-wrapper { position: absolute; top: 20px; bottom: auto; right: 20px; }
        }
        
        .toggle-checkbox { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .toggle-label { position: relative; display: flex; align-items: center; justify-content: space-between; width: 50px; height: 26px; background-color: #e5e7eb; border-radius: 9999px; cursor: pointer; transition: background-color 0.2s ease-in; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .toggle-label:before { content: ""; position: absolute; left: 2px; top: 2px; width: 22px; height: 22px; border-radius: 50%; background-color: white; transition: transform 0.2s ease-in; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-checkbox:checked + .toggle-label { background-color: #cb97a5; }
        .toggle-checkbox:checked + .toggle-label:before { transform: translateX(100%); }
        .toggle-icon { width: 14px; height: 14px; color: white; z-index: 10; }
        .icon-sun { margin-left: 5px; color: #f59e0b; }
        .icon-moon { margin-right: 5px; color: #fff; }

        /* 3D Tilt */
        #previewWrapper { transform-style: preserve-3d; will-change: transform; transform: perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1); }
        .glare-overlay { position: absolute; inset: 0; opacity: 0; mix-blend-mode: overlay; pointer-events: none; z-index: 60; border-radius: inherit; transition: opacity 0.1s ease; }
        
        /* Ring Fix */
        .guard-option-btn.ring-2 {
            box-shadow: 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color), 0 0 0 calc(var(--tw-ring-offset-width) + 2px) var(--tw-ring-color);
            border: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col py-4 text-slate-800 relative transition-colors duration-300 overflow-hidden">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="w-28 h-28 relative">
            <img src="https://mew.cards/gg/img/logo.png" alt="Loading..." class="absolute top-0 left-0 w-full h-full object-contain opacity-30">
            <img id="loading-logo-fg" src="https://mew.cards/gg/img/logo.png" alt="Loading..." class="absolute top-0 left-0 w-full h-full object-contain transition-all duration-100 ease-linear" style="clip-path: inset(100% 0 0 0);">
        </div>
    </div>

    <!-- Dark Mode Toggle -->
    <div class="theme-toggle-wrapper">
        <input type="checkbox" id="darkModeToggle" class="toggle-checkbox">
        <label for="darkModeToggle" class="toggle-label">
            <i data-lucide="sun" class="toggle-icon icon-sun w-3 h-3"></i>
            <i data-lucide="moon" class="toggle-icon icon-moon w-3 h-3"></i>
        </label>
    </div>

    <!-- Header -->
    <header class="text-center pt-6 pb-2 px-4 animate-fade-in-down flex-none z-20 relative">
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900 mb-2">
            Graded Guard <br class="block md:hidden" /> <span style="color: #cb97a5;">Visualizer</span>
        </h1>
    </header>

    <!-- Main Container -->
    <main class="w-full flex-1 relative flex flex-col px-4 lg:px-0 pb-6 overflow-hidden">
        
        <!-- SIDEBAR REOPEN BUTTON -->
        <button id="sidebar-open-btn" onclick="toggleSidebar()" class="hidden absolute left-4 top-1/2 -translate-y-1/2 z-30 bg-white dark:bg-slate-800 p-3 rounded-full shadow-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 transition-all hover:scale-110 group" title="Open Controls">
             <i data-lucide="panel-left-open" class="w-6 h-6"></i>
        </button>

        <!-- Controls Section -->
        <div id="sidebar" class="w-full lg:w-80 flex-none order-2 lg:absolute lg:left-8 lg:top-1/2 lg:-translate-y-1/2 lg:z-20 bg-white rounded-2xl shadow-xl p-6 border border-slate-100 flex flex-col gap-6 transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] h-fit max-h-[85vh] overflow-y-auto">
            
            <button onclick="toggleSidebar()" class="hidden lg:flex absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors" title="Collapse Panel">
                <i data-lucide="panel-left-close" class="w-5 h-5"></i>
            </button>

            <!-- 1. Grading Company Selection -->
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-3 uppercase tracking-wider">1. Grading Company</label>
                <div class="grid grid-cols-3 gap-2 bg-slate-100 p-1 rounded-xl">
                    <button onclick="setCompany('psa')" id="btn-psa" class="company-btn active-company py-2 px-3 rounded-lg text-sm font-bold transition-all text-center">
                        PSA
                    </button>
                    <button disabled id="btn-bgs" class="company-btn py-2 px-3 rounded-lg text-sm font-bold transition-all text-center text-slate-400 cursor-not-allowed opacity-50">
                        BGS
                    </button>
                    <button disabled id="btn-cgc" class="company-btn py-2 px-3 rounded-lg text-sm font-bold transition-all text-center text-slate-400 cursor-not-allowed opacity-50">
                        CGC
                    </button>
                </div>
            </div>

            <!-- 2. Guard Option -->
            <div>
                <div class="flex justify-between items-end mb-1">
                    <label class="block text-sm font-semibold text-slate-700 uppercase tracking-wider mb-0">2. Guard Option</label>
                    <button onclick="toggleFlip()" class="text-xs text-slate-500 hover:text-slate-800 dark:hover:text-slate-300 flex items-center gap-1 transition-colors" title="Flip Guard Vertically">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        <span class="font-medium">Rotate</span>
                    </button>
                </div>

                <span id="colorNameDisplay" class="block text-sm font-medium text-slate-600 mb-3">Current: None</span>
                
                <div id="guardOptionsContainer" class="flex flex-wrap items-center gap-3 mb-4 min-h-[40px]">
                    <span class="text-xs text-slate-400 italic">Loading options...</span>
                </div>
                <input type="hidden" id="customColorInput" value="#d946ef">
            </div>

            <!-- 3. Actions -->
            <div>
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" onclick="findByCert()" class="py-2.5 px-2 rounded-lg border border-blue-200 dark:border-blue-800 text-blue-600 dark:text-blue-400 font-medium text-xs flex items-center justify-center gap-1.5 transition-colors" title="Find by Cert Number">
                        <i data-lucide="search" class="w-3.5 h-3.5"></i>
                        by Cert
                    </button>
                    
                    <button type="button" onclick="clearImage()" class="py-2.5 px-2 rounded-lg border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 font-medium text-xs flex items-center justify-center gap-1.5 transition-colors" title="Remove Image">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        Clear
                    </button>
                    
                    <button id="saveBtn" type="button" onclick="downloadPreview()" class="py-2.5 px-2 rounded-lg border border-slate-200 dark:border-slate-500 text-slate-900 dark:text-slate-200 font-medium text-xs flex items-center justify-center gap-1.5 transition-colors" title="Save Image">
                        <i data-lucide="download" class="w-3.5 h-3.5"></i>
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="flex-1 w-full h-full flex flex-col items-center justify-center order-1 lg:absolute lg:inset-0 lg:z-10 pointer-events-none">
            <div id="previewWrapper" class="relative p-4 md:p-16 rounded-xl pointer-events-auto">
                
                <!-- LAYER 1: The GUARD Container -->
                <div id="guardContainer" class="guard-bumper guard-psa bg-gray-900 w-[320px] md:w-[360px] flex items-center justify-center relative z-0">
                    
                    <!-- Guard Image -->
                    <img id="guardImageOverlay" src="" 
                         onerror="handleImageError(this)"
                         class="absolute z-50 pointer-events-none hidden" 
                         style="width: 106.33%; max-width: none; left: 50%; top: 50%; transform: translate(-50%, -50%); transition: transform 0.3s ease;">

                    <!-- Slab Container -->
                    <div id="slabContainer" class="company-psa w-full relative overflow-hidden bg-white/10 rounded-[18px]">

                        <!-- Glare Overlay -->
                        <div id="glareOverlay" class="glare-overlay"></div>

                        <!-- LAYER 2: The SLAB BASE IMG -->
                        <img id="slabImageOverlay" src="https://mew.cards/gg/img/base_PSA.png" 
                             onerror="handleImageError(this)"
                             class="w-full h-auto relative z-10 pointer-events-none">

                        <!-- LAYER 3: The CARD & UPLOAD ZONE -->
                        <div id="cardLayer" 
                             onclick="document.getElementById('fileInput').click()"
                             class="absolute z-20 flex items-center justify-center transition-all duration-300 cursor-pointer group">
                             
                             <input type="file" id="fileInput" accept="image/*" class="hidden">

                             <img id="userCardImage" src="" class="hidden object-contain shadow-sm pointer-events-none" alt="User Card">
                             
                             <!-- Placeholder -->
                             <div id="cardPlaceholder" class="w-full h-full flex items-center justify-center relative">
                                <img src="https://mew.cards/gg/img/upload.png" 
                                     alt="Upload Here" 
                                     onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden'); if(typeof lucide!=='undefined') lucide.createIcons();"
                                     class="w-full h-full object-contain opacity-100 grayscale-[50%] group-hover:grayscale-0 transition-all duration-300" />
                                     
                                <!-- Fallback Icon -->
                                <div class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400/50 group-hover:text-gray-400 transition-colors">
                                    <i data-lucide="upload-cloud" class="w-12 h-12 mb-1"></i>
                                    <span class="text-[10px] font-bold uppercase tracking-widest">Upload</span>
                                </div>
                             </div>
                        </div>

                        <!-- LAYER 4: PLASTIC GLOSS -->
                        <div class="absolute inset-0 z-30 pointer-events-none opacity-20 bg-gradient-to-tr from-transparent via-white to-transparent mix-blend-overlay"></div>
                        <div class="slab-shine z-30"></div>

                        <!-- LAYER 5: Legacy CSS Overlay -->
                        <div id="slabCssOverlay" class="absolute inset-0 z-40 hidden flex-col slab-css-style">
                             <div class="slab-shine"></div>
                             <div id="cssLabelArea" class="h-[22%] w-full border-b border-gray-200 flex flex-col items-center justify-center bg-gray-50/50 p-2 relative z-20">
                                <div class="w-full h-full border border-gray-200 bg-white shadow-sm flex flex-col items-center justify-center px-2 py-1 relative overflow-hidden">
                                    <div id="labelBorder" class="absolute inset-0 border-4 border-yellow-600 opacity-100 pointer-events-none"></div>
                                    <div class="flex justify-between w-full items-start mb-1">
                                        <span class="text-[8px] font-bold text-gray-400 tracking-tighter">12345678</span>
                                        <span id="companyLabelText" class="text-[10px] font-bold text-gray-800 tracking-wider">BGS</span>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-[10px] uppercase font-bold text-slate-800 leading-tight">2025 PREVIEW</div>
                                    </div>
                                    <div class="absolute bottom-1 right-2 flex items-center gap-1">
                                        <div class="text-lg font-bold text-slate-900 leading-none">9.5</div>
                                    </div>
                                </div>
                             </div>
                             <div class="flex-1"></div> 
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Crop Modal -->
    <div id="cropModal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden flex-col items-center justify-center p-4">
        <!-- UPDATED: Increased width to 90vw and height to 85vh for a much larger workspace -->
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-[90vw] h-[85vh] max-w-7xl shadow-2xl overflow-hidden flex flex-col">
            <div class="flex-none p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                <h3 class="font-bold text-slate-900 dark:text-white">Adjust Image</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex-1 bg-black/5 dark:bg-black/50 p-4 relative flex items-center justify-center overflow-hidden">
                <!-- UPDATED: Removed fixed height, uses h-full to fill the modal -->
                <div class="h-full w-full">
                    <img id="imageToCrop" src="" alt="Crop Preview" class="max-w-full max-h-full block">
                </div>
            </div>

            <div class="flex-none p-4 border-t border-gray-100 dark:border-gray-800 flex justify-end gap-3 bg-white dark:bg-slate-900">
                <button onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Cancel</button>
                <button onclick="applyCrop()" class="px-6 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 shadow-lg transition-all">Apply Card</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            fetchGuardOptions();
            
            IMAGES_TO_PRELOAD.forEach(url => {
                const img = new Image();
                img.onload = updateLoader;
                img.onerror = () => { console.warn("Failed to preload:", url); updateLoader(); };
                img.src = url;
            });
            
            const ringObserver = new MutationObserver((mutations) => {
                 mutations.forEach((mutation) => {
                     if (mutation.attributeName === 'class') {
                         const isDark = document.body.classList.contains('dark-mode');
                         const offsetColor = isDark ? '#27272a' : '#ffffff';
                         const activeBtns = document.querySelectorAll('.guard-option-btn.ring-2');
                         activeBtns.forEach(btn => {
                            btn.style.setProperty('--tw-ring-offset-color', offsetColor);
                         });
                         // Update non-selected buttons to match background as well for hover effect
                         const allBtns = document.querySelectorAll('.guard-option-btn');
                         allBtns.forEach(btn => {
                            if(!btn.classList.contains('ring-2')) {
                                btn.style.setProperty('--tw-ring-offset-color', offsetColor);
                            }
                         });
                     }
                 });
            });
            ringObserver.observe(document.body, { attributes: true });
        });

        // DOM Elements
        const guardContainer = document.getElementById('guardContainer');
        const slabContainer = document.getElementById('slabContainer');
        const previewWrapper = document.getElementById('previewWrapper');
        const glareOverlay = document.getElementById('glareOverlay');
        const guardOptionsContainer = document.getElementById('guardOptionsContainer');
        const colorNameDisplay = document.getElementById('colorNameDisplay');
        
        const cardLayerEl = document.getElementById('cardLayer');
        const slabImageOverlay = document.getElementById('slabImageOverlay');
        const slabCssOverlay = document.getElementById('slabCssOverlay');
        const guardImageOverlay = document.getElementById('guardImageOverlay');
        
        const btnPsa = document.getElementById('btn-psa');
        const btnBgs = document.getElementById('btn-bgs');
        const btnCgc = document.getElementById('btn-cgc');
        
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        const loadingScreen = document.getElementById('loading-screen');
        const loadingLogoFg = document.getElementById('loading-logo-fg');
        
        const sidebar = document.getElementById('sidebar');
        const sidebarOpenBtn = document.getElementById('sidebar-open-btn');

        function toggleSidebar() {
            if (sidebar.classList.contains('translate-x-[-120%]')) {
                sidebar.classList.remove('translate-x-[-120%]', 'opacity-0', 'pointer-events-none');
                sidebarOpenBtn.classList.add('hidden');
                sidebarOpenBtn.classList.remove('flex');
            } else {
                sidebar.classList.add('translate-x-[-120%]', 'opacity-0', 'pointer-events-none');
                sidebarOpenBtn.classList.remove('hidden');
                sidebarOpenBtn.classList.add('flex');
            }
        }

        // CONSTANTS
        const PSA_REF_WIDTH = 1200; 
        const PSA_REF_HEIGHT = 2102; 
        const PSA_CARD_WIDTH_PX = 940;
        const PSA_CARD_BOTTOM_PX = 166;

        // PRELOAD LOGIC
        const IMAGES_TO_PRELOAD = [
            'https://mew.cards/gg/img/logo.png',
            'https://mew.cards/gg/img/base_PSA.png',
            'https://mew.cards/gg/img/GG_PSA_Eclipse.png',
            'https://mew.cards/gg/img/GG_PSA_Fuschia.png',
            'https://mew.cards/gg/img/upload.png'
        ];

        let loadedCount = 0;
        let currentSelectionName = 'None';
        
        function updateLoader() {
            loadedCount++;
            const percentage = Math.round((loadedCount / (IMAGES_TO_PRELOAD.length + 1)) * 100);
            loadingLogoFg.style.clipPath = `inset(${100 - percentage}% 0 0 0)`;

            if (loadedCount >= IMAGES_TO_PRELOAD.length + 1) {
                setTimeout(() => {
                    loadingScreen.classList.add('hidden-loader');
                    document.body.classList.remove('overflow-hidden'); 
                }, 500); 
            }
        }

        // DATA FETCHING
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5OLGw_I77Cxa-6Lq15tV3-pPFgBqcVzQmhYH8SiuyDK8vdvGn4rRH8DAFxdh00IWXXY6savQ5yiPx/pub?output=csv';
        let allGuardOptions = [];
        let currentCompany = 'PSA'; 

        // FALLBACK DATA
        const FALLBACK_OPTIONS = [
             { Grader: 'PSA', Name: 'Fuschia', 'Color 1': '#be81a1', 'Color 2': '#5c4065', 'Color 3': '', Highlight: '#f0abfc', Image: 'GG_PSA_Fuschia.png' },
             { Grader: 'PSA', Name: 'Eclipse', 'Color 1': '#ffffff', 'Color 2': '#000000', 'Color 3': '', Highlight: '#94a3b8', Image: 'GG_PSA_Eclipse.png' }
        ];

        function parseCSV(csv) {
            const lines = csv.split(/\r?\n/).filter(line => line.trim() !== '');
            const clean = (val) => {
                val = val ? val.trim() : '';
                if (val.charCodeAt(0) === 0xFEFF) val = val.slice(1);
                if (val.startsWith('"') && val.endsWith('"')) return val.slice(1, -1).trim();
                return val;
            };
            const headers = lines[0].split(',').map(h => clean(h).trim()); 
            
            return lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const entry = {};
                headers.forEach((h, i) => {
                    if(values[i] !== undefined) {
                        entry[h] = clean(values[i]);
                    }
                });
                return entry;
            });
        }
        
        function normalizeHex(hex) {
            if (!hex) return '#000000';
            hex = hex.trim();

            if (hex.toLowerCase().includes('fuschia') || hex.toLowerCase().includes('fuchsia')) {
                return '#be81a1'; 
            }
            if (hex.toLowerCase() === 'eclipse') return '#ffffff';

            const hexPattern = /^#?[0-9A-Fa-f]{3,8}$/;
            if (hexPattern.test(hex) && !hex.startsWith('#')) {
                return '#' + hex;
            }
            return hex;
        }

        async function fetchGuardOptions() {
            try {
                const response = await fetch(`${SHEET_URL}&t=${Date.now()}`);
                if(!response.ok) throw new Error("Bad response");
                const text = await response.text();
                const parsed = parseCSV(text);
                
                if(parsed.length > 0) {
                    allGuardOptions = parsed;
                } else {
                    allGuardOptions = FALLBACK_OPTIONS;
                }
            } catch (error) {
                console.error('Error fetching options, using fallback:', error);
                allGuardOptions = FALLBACK_OPTIONS;
            }
            
            setCompany('psa'); 
            updateLoader(); 
        }

        function renderGuardOptions(grader) {
            guardOptionsContainer.innerHTML = '';
            const options = allGuardOptions.filter(opt => opt.Grader && opt.Grader.toUpperCase() === grader.toUpperCase());

            if (options.length === 0) {
                guardOptionsContainer.innerHTML = '<span class="text-xs text-slate-400 italic">No options available.</span>';
                return;
            }

            const isDark = document.body.classList.contains('dark-mode');
            const offsetColor = isDark ? '#27272a' : '#ffffff';

            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                const safeName = opt.Name ? opt.Name.replace(/\s+/g, '-').toLowerCase() : `opt-${index}`;
                btn.id = `btn-${safeName}`;
                btn.title = opt.Name || 'Unknown';
                
                // REMOVED border class from main button to fix background clipping issue
                // The border is now applied via the child overlay div
                btn.className = `w-10 h-10 rounded-full shadow-md hover:scale-110 hover:ring-2 transition-all duration-200 ring-offset-2 focus:outline-none guard-option-btn relative overflow-hidden bg-slate-200 dark:bg-slate-700`;
                
                const c1 = normalizeHex(opt['Color 1']);
                const c2 = opt['Color 2'] ? normalizeHex(opt['Color 2']) : null;
                const c3 = opt['Color 3'] ? normalizeHex(opt['Color 3']) : null;
                const c4 = opt['Color 4'] ? normalizeHex(opt['Color 4']) : null; 

                let bgStyle = '';
                if (c4) {
                     bgStyle = `linear-gradient(135deg, ${c1} -10%, ${c1} 25%, ${c2} 25%, ${c2} 50%, ${c3} 50%, ${c3} 75%, ${c4} 75%, ${c4} 110%)`;
                } else if (c3) {
                     bgStyle = `linear-gradient(135deg, ${c1} -10%, ${c1} 33.33%, ${c2} 33.33%, ${c2} 66.66%, ${c3} 66.66%, ${c3} 110%)`;
                } else if (c2) {
                     bgStyle = `linear-gradient(135deg, ${c1} -10%, ${c1} 50%, ${c2} 50%, ${c2} 110%)`; 
                } else {
                     bgStyle = c1;
                }

                btn.style.background = bgStyle;
                btn.style.backgroundColor = c1; 

                const sheen = document.createElement('div');
                sheen.className = 'absolute inset-0 rounded-full bg-gradient-to-tr from-white/40 to-transparent pointer-events-none';
                btn.appendChild(sheen);
                
                // NEW: Border Overlay div - sits on top of everything to provide border without clipping background
                const borderOverlay = document.createElement('div');
                borderOverlay.className = 'absolute inset-0 rounded-full border border-black/10 dark:border-white/10 pointer-events-none';
                btn.appendChild(borderOverlay);
                
                let highlight = opt.Highlight ? normalizeHex(opt.Highlight) : c1;
                if (!highlight || highlight.toLowerCase() === '#ffffff' || highlight.toLowerCase() === '#fff') {
                    highlight = '#94a3b8'; 
                }
                
                btn.style.setProperty('--tw-ring-color', highlight);
                btn.style.setProperty('--tw-ring-offset-color', offsetColor);

                const imgUrl = opt.Image ? `https://mew.cards/gg/img/${opt.Image}` : '';
                
                btn.dataset.hex = c1; 
                btn.dataset.name = opt.Name;
                btn.dataset.image = imgUrl;
                btn.dataset.highlight = highlight; 

                btn.onmouseenter = () => {
                    colorNameDisplay.innerText = `${opt.Name}`;
                };
                
                btn.onmouseleave = () => {
                    colorNameDisplay.innerText = `Current: ${currentSelectionName}`;
                };

                btn.onclick = () => {
                    setGuardOption(c1, opt.Name, imgUrl, btn.id, highlight);
                };

                guardOptionsContainer.appendChild(btn);
            });
        }

        // ... Rest of the script logic stays the same ...
        let isFlipped = false;

        darkModeToggle.addEventListener('change', (e) => {
            if (e.target.checked) document.body.classList.add('dark-mode');
            else document.body.classList.remove('dark-mode');
            
            // Update Ring Offset for hover effects when mode changes
            const offsetColor = e.target.checked ? '#27272a' : '#ffffff';
            const allBtns = document.querySelectorAll('.guard-option-btn');
            allBtns.forEach(btn => {
                btn.style.setProperty('--tw-ring-offset-color', offsetColor);
            });
        });

        // 3D Tilt
        previewWrapper.addEventListener('mousemove', (e) => {
            const rect = previewWrapper.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const px = x / rect.width;
            const py = y / rect.height;
            const featherX = Math.sin(px * Math.PI);
            const featherY = Math.sin(py * Math.PI);
            const strength = Math.pow(featherX * featherY, 0.5);
            const rotateX = (0.5 - py) * 6 * strength; 
            const rotateY = (px - 0.5) * 6 * strength; 
            previewWrapper.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1, 1, 1)`;
            const glareX = 50 + (rotateY * 15); 
            const glareY = 50 - (rotateX * 15);
            const alpha = (0.35 * Math.min(1, Math.hypot(rotateX, rotateY) / 3)).toFixed(2); 
            glareOverlay.style.opacity = alpha;
            glareOverlay.style.background = `radial-gradient(circle at ${glareX}% ${glareY}%, rgba(255,255,255,0.6), transparent 60%)`;
        });

        previewWrapper.addEventListener('mouseleave', () => {
            previewWrapper.style.transition = 'transform 0.5s ease';
            previewWrapper.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)';
            glareOverlay.style.opacity = '0';
            setTimeout(() => previewWrapper.style.transition = '', 500);
        });

        function handleImageError(img) {
            // Only hide if it's supposed to be visible (prevents hiding the placeholder on load)
            if(img.src && img.src !== window.location.href) {
                 console.warn('Image failed to load:', img.id, img.src);
                 img.style.display = 'none';
            }
            
            if (img.id === 'slabImageOverlay') {
                const slabCss = document.getElementById('slabCssOverlay');
                slabCss.classList.remove('hidden');
                slabCss.classList.add('flex');
                document.getElementById('slabContainer').classList.add('h-full');
                document.getElementById('slabContainer').style.aspectRatio = "3.2 / 5.35"; 
            }
            if (img.src && img.src.includes('upload.png')) {
                const fallback = img.nextElementSibling;
                if(fallback) {
                    fallback.classList.remove('hidden'); 
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        }

        function toggleFlip() {
            isFlipped = !isFlipped;
            const guard = document.getElementById('guardImageOverlay');
            if (isFlipped) guard.style.transform = "translate(-50%, -50%) scaleY(-1)";
            else guard.style.transform = "translate(-50%, -50%)";
        }

        function setCompany(company) {
            currentCompany = company.toUpperCase();
            
            guardContainer.className = `w-[320px] md:w-[360px] flex items-center justify-center relative z-0`;
            guardContainer.style.backgroundColor = ''; 
            
            [btnPsa, btnBgs, btnCgc].forEach(btn => {
                btn.className = `company-btn py-2 px-3 rounded-lg text-sm font-bold transition-all text-center text-slate-500 hover:text-slate-700`;
            });

            if (company === 'psa') {
                slabImageOverlay.style.display = 'block'; 
                slabImageOverlay.classList.remove('hidden');
                
                // Only show guard if an option is actually selected
                if(currentSelectionName !== 'None') {
                    guardImageOverlay.style.display = 'block';
                    guardImageOverlay.classList.remove('hidden');
                } else {
                    guardImageOverlay.classList.add('hidden');
                }
                
                slabCssOverlay.classList.add('hidden');
                slabCssOverlay.classList.remove('flex');

                const widthPercent = (PSA_CARD_WIDTH_PX / PSA_REF_WIDTH) * 100;
                const bottomPercent = (PSA_CARD_BOTTOM_PX / PSA_REF_HEIGHT) * 100;
                const leftPercent = (100 - widthPercent) / 2;

                cardLayerEl.style.width = `${widthPercent}%`;
                cardLayerEl.style.left = `${leftPercent}%`;
                cardLayerEl.style.bottom = `${bottomPercent}%`;
                cardLayerEl.style.top = 'auto'; 
                cardLayerEl.style.aspectRatio = "63.5 / 88.9";
                cardLayerEl.style.height = 'auto';
                
                userCardImage.style.width = '100%';
                userCardImage.style.height = '100%';

                btnPsa.className = `company-btn active-company py-2 px-3 rounded-lg text-sm font-bold transition-all text-center bg-white text-slate-900 shadow-sm ring-1 ring-slate-200`;
                
                renderGuardOptions('PSA');
            } else {
                guardContainer.classList.add('guard-bumper', `guard-${company}`, 'bg-gray-900');
                slabContainer.classList.add(`company-${company}`, 'h-full');
                slabImageOverlay.classList.add('hidden');
                guardImageOverlay.classList.add('hidden');
                slabCssOverlay.classList.remove('hidden');
                slabCssOverlay.classList.add('flex');
            }
        }

        function setGuardOption(hex, name, imageUrl, btnId, highlightColor) {
            document.getElementById('customColorInput').value = hex;
            currentSelectionName = name; // Update selection state
            document.getElementById('colorNameDisplay').innerText = `Current: ${name}`;
            
            const guardImg = document.getElementById('guardImageOverlay');
            guardImg.style.display = ''; 
            
            if (imageUrl) {
                guardImg.src = imageUrl;
                if (document.getElementById('btn-psa').classList.contains('active-company')) {
                    guardImg.classList.remove('hidden');
                }
            }
            
            const guardContainer = document.getElementById('guardContainer');
            if (guardContainer.classList.contains('guard-bumper')) {
                guardContainer.style.backgroundColor = hex;
            }

            const buttons = document.querySelectorAll('.guard-option-btn');
            buttons.forEach(btn => {
                btn.classList.remove('ring-2'); 
                btn.style.boxShadow = ''; 
                // Don't remove prop --tw-ring-color as it's needed for hover
            });

            const activeBtn = document.getElementById(btnId);
            if (activeBtn) {
                 activeBtn.classList.add('ring-2'); 
                 // Color prop is already set on creation
                 const isDark = document.body.classList.contains('dark-mode');
                 const offsetColor = isDark ? '#18181b' : '#f3f4f6'; 
                 activeBtn.style.setProperty('--tw-ring-offset-color', offsetColor);
            }
        }

        const fileInput = document.getElementById('fileInput');
        const cropModal = document.getElementById('cropModal');
        const imageToCrop = document.getElementById('imageToCrop');
        let cropper = null;

        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        const dnd = document.getElementById('cardLayer');
        dnd.addEventListener('dragover', (e) => { e.preventDefault(); document.body.classList.add('drop-active'); });
        dnd.addEventListener('dragleave', (e) => { e.preventDefault(); document.body.classList.remove('drop-active'); });
        dnd.addEventListener('drop', (e) => { e.preventDefault(); document.body.classList.remove('drop-active'); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgEl = document.getElementById('imageToCrop');
                    const modalEl = document.getElementById('cropModal');
                    if(cropper) { cropper.destroy(); cropper = null; }
                    if (imgEl) {
                        imgEl.src = e.target.result;
                        modalEl.classList.remove('hidden');
                        modalEl.classList.add('flex');
                        setTimeout(() => { 
                            cropper = new Cropper(imgEl, { viewMode: 1, background: false, autoCropArea: 0.9, zoomable: true, aspectRatio: 63.5 / 88.9, ready() {} }); 
                        }, 100);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        window.closeModal = function() { cropModal.classList.add('hidden'); cropModal.classList.remove('flex'); if (cropper) { cropper.destroy(); cropper = null; } fileInput.value = ''; }
        window.applyCrop = function() {
            if (cropper) {
                const cvs = cropper.getCroppedCanvas({ maxWidth: 1024, maxHeight: 1024, fillColor: '#fff' });
                const rounded = document.createElement('canvas'); rounded.width = cvs.width; rounded.height = cvs.height; 
                const ctx = rounded.getContext('2d'); 
                const r = (cvs.width / 63.5) * 3;
                ctx.beginPath(); ctx.moveTo(r, 0); ctx.lineTo(rounded.width-r, 0); ctx.quadraticCurveTo(rounded.width, 0, rounded.width, r); ctx.lineTo(rounded.width, rounded.height-r); ctx.quadraticCurveTo(rounded.width, rounded.height, rounded.width-r, rounded.height); ctx.lineTo(r, rounded.height); ctx.quadraticCurveTo(0, rounded.height, 0, rounded.height-r); ctx.lineTo(0, r); ctx.quadraticCurveTo(0, 0, r, 0); ctx.closePath(); ctx.clip(); ctx.drawImage(cvs, 0, 0);
                
                const userImg = document.getElementById('userCardImage');
                userImg.src = rounded.toDataURL('image/png'); 
                userImg.classList.remove('hidden'); 
                document.getElementById('cardPlaceholder').classList.add('hidden'); 
                closeModal();
            }
        }
        window.clearImage = function() { 
            document.getElementById('userCardImage').src = ''; 
            document.getElementById('userCardImage').classList.add('hidden'); 
            document.getElementById('cardPlaceholder').classList.remove('hidden'); 
            fileInput.value = ''; 
        }
        window.downloadPreview = function() {
            html2canvas(previewWrapper, { useCORS: true, backgroundColor: null, scale: 2 }).then(canvas => {
                const link = document.createElement('a'); link.download = 'graded-guard-preview.png'; link.href = canvas.toDataURL('image/png'); link.click();
            }).catch(err => alert("Save failed. Check console"));
        }
        
        // UPDATED: Now prompts user for Cert # and opens the PSA page
        window.findByCert = () => {
            const cert = prompt("Please enter the PSA Certification Number:");
            if (cert && cert.trim()) {
                window.open(`https://www.psacard.com/cert/${cert.trim()}`, '_blank');
            }
        };
    </script>
</body>
</html>
